<!DOCTYPE html>
<html lang="ko">
  <head>
    <!-- í˜ì´ì§€ ê¸°ë³¸ ì„¤ì • ë° ì™¸ë¶€ ìŠ¤íƒ€ì¼ -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë©”ëª¨ ì¶”ê°€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ -->
    <style>
      .btn-active {
        background-color: rgb(251 191 36) !important; /* bg-yellow-400 */
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen p-8">
    <!-- í¬ìŠ¤íŠ¸ì‡ ìŠ¤íƒ€ì¼ ë©”ëª¨ ì¶”ê°€ ì¹´ë“œ -->
    <div
      class="max-w-lg w-full bg-yellow-200 shadow-lg transform rotate-1 relative mx-auto mt-10">
      <!-- í¬ìŠ¤íŠ¸ì‡ ìƒë‹¨ ì ‘ì°© í…Œì´í”„ íš¨ê³¼ -->
      <div
        class="absolute -top-1 left-1/4 w-20 h-8 bg-gray-200 opacity-80 rounded-b-lg shadow-md border border-gray-300"></div>
      <div
        class="absolute -top-1 left-1/4 w-20 h-8 bg-white opacity-60 rounded-b-lg"></div>

      <!-- ë©”ëª¨ ì‘ì„± ë‚´ìš© -->
      <div class="pt-10 pl-6 pr-8 pb-6">
        <!-- ì œëª© -->
        <h1 class="text-xl font-bold text-gray-800 mb-6 ml-2">ìƒˆ ë©”ëª¨ ì‘ì„±</h1>

        <!-- ë©”ëª¨ ì‘ì„± í¼ -->
        <form id="memoForm" onsubmit="return false;">
          <!-- ì œëª© ì…ë ¥ -->
          <input
            type="text"
            id="title"
            name="title"
            class="w-full bg-yellow-300 border-0 border-b-2 border-gray-400 bg-transparent px-2 py-2 mb-6 focus:outline-none focus:border-gray-600 placeholder-gray-500 ml-2"
            placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />

          <!-- ê°„ë‹¨í•œ íˆ´ë°” -->
          <div class="flex space-x-2 mb-4 ml-2">
            <!-- Bold -->
            <button
              id="boldBtn"
              type="button"
              onclick="execCmd('bold')"
              class="px-2 py-1 bg-yellow-300 hover:bg-yellow-400 rounded text-sm font-bold">
              B
            </button>

            <!-- Italic -->
            <button
              id="italicBtn"
              type="button"
              onclick="execCmd('italic')"
              class="px-2 py-1 bg-yellow-300 hover:bg-yellow-400 rounded text-sm italic">
              I
            </button>

            <!-- Underline -->
            <button
              id="underlineBtn"
              type="button"
              onclick="execCmd('underline')"
              class="px-2 py-1 bg-yellow-300 hover:bg-yellow-400 rounded text-sm underline">
              U
            </button>

            <!-- Align -->
            <button
              id="alignBtn"
              type="button"
              onclick="toggleTextAlign()"
              class="px-2 py-1 bg-yellow-300 hover:bg-yellow-400 rounded text-sm">
              ì¤‘ì•™
            </button>

            <button
              type="button"
              onclick="toggleChat()"
              class="px-2 py-1 bg-blue-300 hover:bg-blue-400 rounded text-sm">
              ğŸ¤– AI ë„ì›€
            </button>
          </div>

          <!-- ë‚´ìš© ì…ë ¥ ì˜ì—­ -->
          <div class="relative mb-6 ml-2 bg-yellow-300">
            <div
              id="editor"
              contenteditable="true"
              class="w-full h-48 bg-transparent border-0 px-2 py-2 focus:outline-none text-gray-700 leading-relaxed overflow-y-auto min-h-[192px] max-h-[192px]"></div>
            <div
              id="placeholder"
              class="absolute top-2 left-2 text-gray-500 pointer-events-none select-none">
              ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...
            </div>
          </div>

          <!-- íƒœê·¸ ì…ë ¥ -->
          <input
            type="text"
            id="tags"
            class="w-full bg-yellow-300 border-0 border-b border-gray-400 bg-transparent px-2 py-2 mb-4 focus:outline-none focus:border-gray-600 placeholder-gray-500 ml-2 text-sm"
            placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)" />

          <!-- ë¼ìš´ì§€ ê³µìœ  ì²´í¬ë°•ìŠ¤ -->
          <div class="flex items-center mb-8 ml-2">
            <input
              type="checkbox"
              id="shareToLounge"
              class="mr-2 w-4 h-4 text-purple-600 bg-yellow-100 border-purple-300 rounded focus:ring-purple-500" />
            <label
              for="shareToLounge"
              class="text-sm text-gray-700 cursor-pointer">
              ğŸ“¢ ë¼ìš´ì§€ì— ê³µìœ í•˜ê¸° (ëª¨ë“  íšŒì›ì´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)
            </label>
          </div>

          <!-- ë²„íŠ¼ -->
          <div class="flex justify-between items-center ml-2">
            <a
              href="/main"
              class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition">
              â† ë’¤ë¡œê°€ê¸°
            </a>
            <button
              type="submit"
              class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
              ì €ì¥
            </button>
          </div>
        </form>
      </div>

      <!-- í¬ìŠ¤íŠ¸ì‡ ê·¸ë¦¼ì íš¨ê³¼ -->
      <div
        class="absolute inset-0 bg-yellow-400 opacity-20 -z-10 transform translate-x-1 translate-y-1 rounded"></div>
    </div>

    <!-- ë©”ëª¨ ì‘ì„± ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
      const editor = document.getElementById("editor");
      const placeholder = document.getElementById("placeholder");

      function togglePlaceholder() {
        placeholder.style.display =
          editor.innerText.trim() === "" ? "block" : "none";
      }

      function execCmd(command, value = null) {
        editor.focus();
        document.execCommand(command, false, value);
        updateButtonStates(); // ëª…ë ¹ ì‹¤í–‰ í›„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      }

      // ì•ˆì „í•œ í…ìŠ¤íŠ¸ ì •ë ¬ í•¨ìˆ˜
      let isTextCentered = false;
      function toggleTextAlign() {
        editor.focus();
        if (isTextCentered) {
          editor.style.textAlign = "left";
          isTextCentered = false;
        } else {
          editor.style.textAlign = "center";
          isTextCentered = true;
        }
        updateButtonStates(); // ì •ë ¬ ë³€ê²½ í›„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      }

      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateButtonStates() {
        const boldBtn = document.getElementById("boldBtn");
        const italicBtn = document.getElementById("italicBtn");
        const underlineBtn = document.getElementById("underlineBtn");
        const alignBtn = document.getElementById("alignBtn");

        // execCommand ìƒíƒœ í™•ì¸
        if (document.queryCommandState("bold")) {
          boldBtn.classList.add("btn-active");
        } else {
          boldBtn.classList.remove("btn-active");
        }

        if (document.queryCommandState("italic")) {
          italicBtn.classList.add("btn-active");
        } else {
          italicBtn.classList.remove("btn-active");
        }

        if (document.queryCommandState("underline")) {
          underlineBtn.classList.add("btn-active");
        } else {
          underlineBtn.classList.remove("btn-active");
        }

        // í…ìŠ¤íŠ¸ ì •ë ¬ ìƒíƒœ í™•ì¸
        if (isTextCentered) {
          alignBtn.classList.add("btn-active");
        } else {
          alignBtn.classList.remove("btn-active");
        }
      }

      editor.addEventListener("input", function () {
        togglePlaceholder();
        updateButtonStates();
      });
      editor.addEventListener("focus", function () {
        togglePlaceholder();
        updateButtonStates();
      });
      editor.addEventListener("blur", togglePlaceholder);
      editor.addEventListener("keyup", updateButtonStates);
      editor.addEventListener("mouseup", updateButtonStates);

      togglePlaceholder();
      updateButtonStates(); // ì´ˆê¸° ìƒíƒœ ì„¤ì •

      // submit ì „ì— ë‚´ìš©ê°’ ì €ì¥
      async function saveMemo() {
        const title = document.getElementById("title").value;
        const content = document.getElementById("editor").innerHTML;
        const tagsRaw = document.getElementById("tags").value.trim();
        const shareToLounge = document.getElementById("shareToLounge").checked;

        if (!title.trim()) {
          alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
          return;
        }

        if (!content.trim()) {
          alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
          return;
        }

        const tags = tagsRaw
          ? tagsRaw
              .split(",")
              .map((t) => t.trim())
              .filter((t) => t)
          : [];

        const csrfToken = getCookie("csrf_access_token");
        try {
          const res = await fetch("/memo_add", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-TOKEN": csrfToken,
            },
            body: JSON.stringify({
              title,
              content,
              tags,
              share: shareToLounge,
            }),
            credentials: "include",
          });

          if (!res.ok) {
            alert("ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨!");
            return;
          }
          alert("ì €ì¥ ì™„ë£Œ!");
          window.location.href = "/main";
        } catch (error) {
          alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

      document
        .getElementById("memoForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          saveMemo();
        });
      // AI ì±„íŒ… ê¸°ëŠ¥
      function toggleChat() {
        const panel = document.getElementById("aiPanel");
        panel.classList.toggle("hidden");
      }
      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();
        if (!message) return;

        const chatWindow = document.getElementById("chatWindow");
        chatWindow.innerHTML += `<div class="mb-1"><strong>ğŸ™‹â€â™€ï¸ : </strong> ${message}</div>`;
        input.value = "";

        // âœ… GPT ì‘ë‹µ ëŒ€ê¸° í‘œì‹œ
        const thinkingId = `thinking-${Date.now()}`;
        chatWindow.innerHTML += `<div class="mb-1 text-gray-500" id="${thinkingId}">ğŸ¤– : â³ GPTê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤...</div>`;
        chatWindow.scrollTop = chatWindow.scrollHeight;

        try {
          const csrfToken = getCookie("csrf_access_token");
          const res = await fetch("/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-TOKEN": csrfToken,
            },
            credentials: "include",
            body: JSON.stringify({ message }),
          });

          const data = await res.json();
          const raw = data.reply;

          try {
            const parsed = JSON.parse(raw);
            const finalMsg = `<strong>ğŸ¤– : </strong> ğŸ’­${parsed.insight}<br>ğŸš€${parsed.summary}<br>ğŸ›¬${parsed.action}`;

            // âœ… ëŒ€ê¸° ë©”ì‹œì§€ë¥¼ ì‹¤ì œ ì‘ë‹µìœ¼ë¡œ êµì²´
            document.getElementById(thinkingId).innerHTML = finalMsg;
          } catch (err) {
            document.getElementById(
              thinkingId
            ).innerHTML = `<span class="text-red-500">:x: GPT ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨</span>`;
          }

          chatWindow.scrollTop = chatWindow.scrollHeight;
        } catch (err) {
          document.getElementById(
            thinkingId
          ).innerHTML = `<span class="text-red-500">:x: GPT ì‘ë‹µ ì‹¤íŒ¨</span>`;
        }
      }

      editor.addEventListener("paste", function (e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData(
          "text/plain"
        );
        document.execCommand("insertText", false, text);
      });
    </script>

    <!-- GPT ëŒ€í™” íŒ¨ë„ -->
    <div
      id="aiPanel"
      class="hidden fixed right-0 top-0 h-full w-full max-w-sm bg-white shadow-lg z-50 p-4 border-l border-gray-300">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-lg font-bold text-gray-800">ğŸ¤– AI ë„ìš°ë¯¸</h2>
        <button
          onclick="toggleChat()"
          class="text-gray-500 hover:text-gray-700 text-sm">
          ë‹«ê¸° âœ–
        </button>
      </div>

      <div
        id="chatWindow"
        class="h-[75%] overflow-y-auto bg-gray-50 border rounded p-2 mb-2 text-sm text-gray-800"></div>

      <div class="flex">
        <input
          id="chatInput"
          type="text"
          placeholder="GPTì—ê²Œ ì§ˆë¬¸í•´ë³´ì„¸ìš”"
          class="flex-grow border px-2 py-1 mr-2 text-sm rounded" />
        <button
          onclick="sendMessage()"
          class="bg-blue-500 text-white px-3 py-1 rounded text-sm">
          ì „ì†¡
        </button>
      </div>
    </div>
  </body>
</html>
