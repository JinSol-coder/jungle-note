<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ë©”ëª¨ ì¶”ê°€</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-start py-10">

    <!-- í˜ì´ì§€ ë§¨ ìœ„ ì œëª© -->
    <div class="w-full text-center mb-6 mt-10">
        <h1 class="text-4xl font-bold text-gray-800">ë©”ëª¨ ì¶”ê°€</h1>
    </div>

    <form id="memoForm" onsubmit="return false;" class="w-full max-w-xl px-4">
        <!-- ì œëª© -->
        <input type="text" id="title" name="title" class="w-full border border-gray-400 px-3 py-2 rounded focus:outline-none mb-4" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"/>

        <!-- íˆ´ë°” -->
        <div class="flex space-x-3 text-gray-700 text-sm py-2">
            <div class="border-l mx-2 h-5"></div>
            <button type="button" onclick="execCmd('bold')" class="px-2 py-1 hover:bg-gray-200 rounded font-bold">B</button>
            <div class="border-l mx-2 h-5"></div>
            <button type="button" onclick="execCmd('italic')" class="px-2 py-1 hover:bg-gray-200 rounded italic">I</button>
            <div class="border-l mx-2 h-5"></div>
            <button type="button" onclick="execCmd('underline')" class="px-2 py-1 hover:bg-gray-200 rounded underline">U</button>
            <div class="border-l mx-2 h-5"></div>
            <button type="button" onclick="execCmd('strikeThrough')" class="px-2 py-1 hover:bg-gray-200 rounded line-through">S</button>
            <div class="border-l mx-2 h-5"></div>
            <button type="button" onclick="execCmd('justifyLeft')" class="px-2 py-1 hover:bg-gray-200 rounded">å·¦</button>
            <div class="border-l mx-2 h-5"></div>
            <button type="button" onclick="execCmd('justifyCenter')" class="px-2 py-1 hover:bg-gray-200 rounded">ä¸­</button>
            <div class="border-l mx-2 h-5"></div>
            <button type="button" onclick="execCmd('justifyRight')" class="px-2 py-1 hover:bg-gray-200 rounded">å³</button>
            <div class="border-l mx-2 h-5"></div>
        </div>

        <!-- ë‚´ìš© ì…ë ¥ ì˜ì—­ -->
        <div class="relative mb-6">
            <div id="editor" contenteditable="true"
                class="w-full h-60 border border-gray-400 px-3 py-2 rounded focus:outline-none bg-white overflow-y-auto">
            </div>
            <div id="placeholder"
                class="absolute top-[0.5rem] left-[0.75rem] text-gray-400 pointer-events-none select-none">
                ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”
            </div>
            <input type="hidden" name="content" id="hiddenContent">
            <input type="text" id="tags" placeholder="íƒœê·¸ë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥ (ì˜ˆ: ì•Œê³ ë¦¬ì¦˜, Python)" class="border px-3 py-2 rounded" />
        </div>
        <!-- ë²„íŠ¼ -->
        <div class="mt-6 flex justify-center space-x-4">
            <button type="submit" class="bg-orange-500 text-white px-10 py-2 rounded hover:bg-orange-600">ì €ì¥</button>
            <a href="/main" class="bg-blue-500 text-white px-10 py-2 rounded hover:bg-blue-600 text-center">ë’¤ë¡œê°€ê¸°</a>
        </div>

    </form>

    <!-- ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        const editor = document.getElementById('editor');
        const placeholder = document.getElementById('placeholder');
        const hiddenInput = document.getElementById('hiddenContent');

        function togglePlaceholder() {
            placeholder.style.display = editor.innerText.trim() === '' ? 'block' : 'none';
        }

        function execCmd(command, value = null) {
            editor.focus();
            document.execCommand(command, false, value);
        }

        editor.addEventListener('input', togglePlaceholder);
        editor.addEventListener('focus', togglePlaceholder);
        editor.addEventListener('blur', togglePlaceholder);
        togglePlaceholder();

        // submit ì „ì— ë‚´ìš©ê°’ ì €ì¥
        async function saveMemo() {
            const title = document.getElementById("title").value;
            const content = document.getElementById("editor").innerHTML;
            const tagsRaw = document.getElementById('tags').value.trim();

            const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(t => t) : [];

            const csrfToken = getCookie("csrf_access_token"); // ğŸª ì¿ í‚¤ì—ì„œ CSRF êº¼ë‚´ê¸°
            const res = await fetch("/memo_add", {
                method: "POST",
                headers: {
                "Content-Type": "application/json",
                "X-CSRF-TOKEN": csrfToken  // ğŸ”’ CSRF í¬í•¨!
                },
                body: JSON.stringify({ title, content, tags }),
                credentials: "include"  // ğŸª ì¿ í‚¤ í¬í•¨
            });

            if (!res.ok) {
                alert("ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨!");
                return;
            }
            alert("ì €ì¥ ì™„ë£Œ!");
            window.location.href = "/main";
        }

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            document.getElementById('memoForm').addEventListener('submit', function (e) {
                e.preventDefault(); // ğŸ‘ˆ ê¸°ë³¸ ë™ì‘ ë§‰ê¸°!
                saveMemo();         // ğŸ‘ˆ fetchë¡œ ì§ì ‘ ì²˜ë¦¬
            });
    </script>

</body>
</html>
