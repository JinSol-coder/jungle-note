<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메모 추가</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">

    <!-- 포스트잇 스타일 메모 추가 카드 -->
    <div class="max-w-lg w-full bg-yellow-200 shadow-lg transform rotate-1 relative mx-auto mt-10">
        <!-- 포스트잇 상단 접착 테이프 효과 -->
        <div class="absolute -top-1 left-1/4 w-20 h-8 bg-gray-200 opacity-80 rounded-b-lg shadow-md border border-gray-300"></div>
        <div class="absolute -top-1 left-1/4 w-20 h-8 bg-white opacity-60 rounded-b-lg"></div>
        
        <!-- 메모 작성 내용 -->
        <div class="pt-10 pl-6 pr-8 pb-6">
            <!-- 제목 -->
            <h1 class="text-xl font-bold text-gray-800 mb-6 ml-2">새 메모 작성</h1>

            <form id="memoForm" onsubmit="return false;">
                <!-- 제목 입력 -->
                <input type="text" id="title" name="title" 
                       class="w-full border-0 border-b-2 border-gray-400 bg-transparent px-2 py-2 mb-6 focus:outline-none focus:border-gray-600 placeholder-gray-500 ml-2" 
                       placeholder="제목을 입력하세요"/>

                <!-- 간단한 툴바 -->
                <div class="flex space-x-2 mb-4 ml-2">
                    <button type="button" onclick="execCmd('bold')" class="px-2 py-1 bg-yellow-300 hover:bg-yellow-400 rounded text-sm font-bold">B</button>
                    <button type="button" onclick="execCmd('italic')" class="px-2 py-1 bg-yellow-300 hover:bg-yellow-400 rounded text-sm italic">I</button>
                    <button type="button" onclick="execCmd('underline')" class="px-2 py-1 bg-yellow-300 hover:bg-yellow-400 rounded text-sm underline">U</button>
                    <button type="button" onclick="execCmd('justifyCenter')" class="px-2 py-1 bg-yellow-300 hover:bg-yellow-400 rounded text-sm">중앙</button>
                </div>

                <!-- 내용 입력 영역 -->
                <div class="relative mb-6 ml-2">
                    <div id="editor" contenteditable="true"
                        class="w-full h-48 bg-transparent border-0 px-2 py-2 focus:outline-none text-gray-700 leading-relaxed overflow-y-auto">
                    </div>
                    <div id="placeholder"
                        class="absolute top-2 left-2 text-gray-500 pointer-events-none select-none">
                        내용을 입력하세요...
                    </div>
                </div>

                <!-- 태그 입력 -->
                <input type="text" id="tags" 
                       class="w-full border-0 border-b border-gray-400 bg-transparent px-2 py-2 mb-8 focus:outline-none focus:border-gray-600 placeholder-gray-500 ml-2 text-sm" 
                       placeholder="태그 (쉼표로 구분)" />

                <!-- 버튼 -->
                <div class="flex justify-between items-center ml-2">
                    <a href="/main" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition">
                        ← 뒤로가기
                    </a>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                        저장
                    </button>
                </div>
            </form>
        </div>
        
        <!-- 포스트잇 그림자 효과 -->
        <div class="absolute inset-0 bg-yellow-400 opacity-20 -z-10 transform translate-x-1 translate-y-1 rounded"></div>
    </div>

    <!-- 스크립트 -->
    <script>
        const editor = document.getElementById('editor');
        const placeholder = document.getElementById('placeholder');

        function togglePlaceholder() {
            placeholder.style.display = editor.innerText.trim() === '' ? 'block' : 'none';
        }

        function execCmd(command, value = null) {
            editor.focus();
            document.execCommand(command, false, value);
        }

        editor.addEventListener('input', togglePlaceholder);
        editor.addEventListener('focus', togglePlaceholder);
        editor.addEventListener('blur', togglePlaceholder);
        togglePlaceholder();

        // submit 전에 내용값 저장
        async function saveMemo() {
            const title = document.getElementById("title").value;
            const content = document.getElementById("editor").innerHTML;
            const tagsRaw = document.getElementById('tags').value.trim();

            if (!title.trim()) {
                alert("제목을 입력해주세요!");
                return;
            }

            if (!content.trim()) {
                alert("내용을 입력해주세요!");
                return;
            }

            const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(t => t) : [];

            const csrfToken = getCookie("csrf_access_token");
            try {
                const res = await fetch("/memo_add", {
                    method: "POST",
                    headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-TOKEN": csrfToken
                    },
                    body: JSON.stringify({ title, content, tags }),
                    credentials: "include"
                });

                if (!res.ok) {
                    alert("메모 저장 실패!");
                    return;
                }
                alert("저장 완료!");
                window.location.href = "/main";
            } catch (error) {
                alert("오류가 발생했습니다.");
            }
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        document.getElementById('memoForm').addEventListener('submit', function (e) {
            e.preventDefault();
            saveMemo();
        });
    </script>

</body>
</html>
